<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Dream-Link Results</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary: #0056b3; 
            --accent: #6f42c1; 
            --bg: #f4f7f6;
            --text: #333;
            --radius: 8px;
        }

        body { font-family: 'Poppins', sans-serif; background-color: var(--bg); margin: 0; padding: 0; color: var(--text); -webkit-font-smoothing: antialiased; }

        /* Header */
        header { background: linear-gradient(135deg, #0056b3, #004494); color: white; padding: 12px 0; text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        header h1 { margin: 0; font-size: 1.3rem; letter-spacing: 0.5px; }
        .sub-head { font-size: 0.8rem; opacity: 0.9; margin-top: 2px; font-weight: 400; }

        /* Container */
        .container { max-width: 800px; margin: 10px auto; padding: 10px; background: white; border-radius: var(--radius); }

        /* Search Box */
        .search-box { display: flex; gap: 8px; margin-bottom: 15px; }
        .form-group { flex: 1; }
        select, input { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: var(--radius); font-size: 0.9rem; box-sizing: border-box; outline: none; background: #fafafa; }
        select:focus, input:focus { border-color: var(--primary); background: #fff; }
        
        button.search-btn { width: 100%; padding: 10px; background: var(--primary); color: white; border: none; border-radius: var(--radius); cursor: pointer; font-weight: 600; font-size: 0.95rem; }

        /* RESULT CARD */
        #result-area { display: none; margin-top: 15px; border: 1px solid #eee; border-radius: var(--radius); overflow: hidden; background: #fff; }
        .res-header { background: #e3f2fd; padding: 8px; text-align: center; font-size: 0.95rem; color: var(--primary); font-weight: 700; border-bottom: 1px solid #bbdefb; }
        
        .compact-grid { display: grid; grid-template-columns: 1fr 1fr; font-size: 0.85rem; }
        .c-row { padding: 6px 12px; border-bottom: 1px solid #f5f5f5; display: flex; justify-content: space-between; align-items: center; }
        .c-row:nth-child(odd) { border-right: 1px solid #f5f5f5; }
        .c-label { color: #666; font-weight: 500; font-size: 0.8rem; }
        .c-val { font-weight: 700; color: #222; }
        .c-highlight { color: var(--primary); font-weight: 800; }

        /* ANALYZER SECTIONS */
        #analyzer-area { display: none; margin-top: 20px; }
        
        .sec-title { 
            font-size: 1rem; font-weight: 700; color: #333; margin: 15px 0 10px 0; 
            border-left: 4px solid var(--primary); padding-left: 8px; display: flex; align-items: center; justify-content: space-between;
        }
        .shift-color { border-color: var(--accent); color: var(--accent); }

        /* Range Box */
        .range-filter-box {
            background: #fdfdfd; border: 1px dashed #ced4da; padding: 8px; border-radius: var(--radius);
            display: flex; align-items: center; justify-content: center; gap: 8px; margin-bottom: 15px; flex-wrap: wrap;
        }
        .range-inp { width: 70px; padding: 5px; border: 1px solid #ccc; border-radius: 4px; text-align: center; font-weight: bold; font-size: 0.9rem; }
        .range-btn { background: var(--accent); color: white; border: none; padding: 6px 15px; border-radius: 4px; cursor: pointer; font-size: 0.8rem; font-weight: 600; }

        /* Badges */
        .rank-badges { display: grid; grid-template-columns: repeat(4, 1fr); gap: 6px; margin-bottom: 15px; }
        @media (max-width: 450px) { .rank-badges { grid-template-columns: repeat(2, 1fr); } }
        .badge { background: #fff; border: 1px solid #eee; padding: 8px 4px; border-radius: var(--radius); text-align: center; box-shadow: 0 1px 3px rgba(0,0,0,0.02); }
        .badge span { display: block; font-size: 0.65rem; color: #888; margin-bottom: 2px; text-transform: uppercase; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .badge strong { display: block; font-size: 1.1rem; color: var(--primary); line-height: 1; font-weight: 800; }
        .badge.b-shift strong { color: var(--accent); }

        /* Tables */
        .table-wrapper { overflow-x: auto; border: 1px solid #eee; border-radius: var(--radius); margin-bottom: 10px; -webkit-overflow-scrolling: touch; }
        table.stats-table { width: 100%; border-collapse: collapse; font-size: 0.75rem; min-width: 100%; }
        
        .stats-table th { background: #f8f9fa; color: #555; font-weight: 700; text-transform: uppercase; padding: 8px 4px; text-align: center; border-bottom: 2px solid #ddd; font-size: 0.7rem; white-space: nowrap; }
        .stats-table td { padding: 6px 4px; border-bottom: 1px solid #f0f0f0; text-align: center; color: #444; font-weight: 500; }
        
        /* Columns */
        .col-cat { width: 25%; text-align: left !important; padding-left: 8px !important; }
        .col-data { width: 14%; }
        .tsp-head { color: #888 !important; font-style: italic; background: #fff !important; border-left: 1px solid #eee; }
        .tsp-cell { color: #999; font-style: italic; background: #fcfcfc; border-left: 1px solid #eee; font-size: 0.7rem; }
        
        /* Tags & Rows */
        .cat-tag { display: inline-block; padding: 2px 6px; border-radius: 3px; color: white; font-size: 0.7rem; font-weight: bold; width: 35px; text-align: center;}
        .bg-GEN { background-color: #6c757d; } .bg-OBC { background-color: #007bff; } .bg-EWS { background-color: #17a2b8; }
        .bg-MBC { background-color: #6610f2; } .bg-SC { background-color: #e83e8c; } .bg-ST { background-color: #fd7e14; } .bg-SAH { background-color: #28a745; }

        .sub-row td { background-color: #fcfcfc; color: #666; font-size: 0.7rem; border-bottom: 1px dashed #eee; height: 25px;}
        .sub-label { display: flex; align-items: center; gap: 4px; color: #555; font-weight: 400; padding-left: 12px !important; }
        .sub-icon { font-size: 0.6rem; color: #bbb; }
        .row-total { font-weight: 800; color: #000; background: #f9f9f9; }

        /* NEW: Grand Total Row Style */
        .grand-total-row td {
            background-color: #e8eaf6;
            color: #1a237e;
            font-weight: 800;
            border-top: 2px solid #c5cae9;
            font-size: 0.8rem;
        }

        /* Print Settings */
        @media print {
            header, .search-box, button, footer, .range-filter-box { display: none !important; }
            body { background: white; margin: 0; padding: 0; }
            .container { box-shadow: none; border: none; margin: 0; padding: 0; max-width: 100%; }
            #result-area, #analyzer-area { display: block !important; }
            #print-header { display: block !important; text-align: center; border-bottom: 2px solid #000; margin-bottom: 15px; padding-bottom: 5px; }
            .badge { border: 1px solid #000; }
            table th { background: #eee !important; color: #000; }
            .grand-total-row td { background-color: #ddd !important; -webkit-print-color-adjust: exact; }
            .shift-section-wrapper { page-break-before: always; margin-top: 20px; display: block; }
        }
    </style>
</head>
<body>

    <header>
        <h1>Dream-Link Results</h1>
        <div class="sub-head">Analyse by MP SALODIYA</div>
    </header>

    <div class="container">

        <div id="print-header" style="display: none;">
            <h3>Dream-Link Results</h3>
            <p style="font-size: 0.9rem;">Analyse by MP SALODIYA</p>
        </div>
        
        <div class="search-box">
            <div class="form-group" style="flex: 0.6;">
                <select id="examType">
                    <option value="NTSP">NTSP</option>
                    <option value="TSP">TSP</option>
                </select>
            </div>
            <div class="form-group" style="flex: 1.4;">
                <input type="number" id="rollInput" placeholder="Enter Roll Number">
            </div>
        </div>
        <button class="search-btn" onclick="processResult()">Search & Analyze</button>
        <div id="status-msg" style="text-align: center; margin-top: 5px; font-weight: 500; font-size: 0.8rem; min-height: 15px;"></div>

        <div id="result-area">
            <div class="res-header">CANDIDATE SCORECARD</div>
            <div class="compact-grid">
                <div class="c-row"><div class="c-label">Roll No</div> <div class="c-val" id="d_roll">-</div></div>
                <div class="c-row"><div class="c-label">Category</div> <div class="c-val" id="d_cat">-</div></div>
                
                <div class="c-row"><div class="c-label">Name</div> <div class="c-val" id="d_name">-</div></div>
                <div class="c-row"><div class="c-label">Gender</div> <div class="c-val" id="d_gender">-</div></div>

                <div class="c-row"><div class="c-label">Father</div> <div class="c-val" id="d_father">-</div></div>
                <div class="c-row"><div class="c-label">Mother</div> <div class="c-val" id="d_mother">-</div></div>

                <div class="c-row"><div class="c-label">Shift</div> <div class="c-val" id="d_shift">-</div></div>
                <div class="c-row"><div class="c-label">Final Marks</div> <div class="c-val c-highlight" id="d_final">-</div></div>

                <div class="c-row"><div class="c-label">Raw Marks</div> <div class="c-val" id="d_raw">-</div></div>
                <div class="c-row"><div class="c-label">Right Que</div> <div class="c-val" id="d_rightq" style="color: green;">-</div></div>
                
                <div class="c-row" style="grid-column: span 2; background: #fffbe6; justify-content: center; gap: 8px; border-top: 1px solid #e0e0e0; padding: 8px;">
                    <span class="c-label">OVERALL MERIT RANK:</span> 
                    <span class="c-val c-highlight" style="font-size: 1rem;" id="d_merit">-</span>
                </div>
            </div>
        </div>

        <div id="analyzer-area">
            
            <div class="sec-title">üìä Deep Merit Analysis</div>
             <div class="rank-badges">
                <div class="badge"><span>Overall</span><strong id="an_merit">-</strong></div>
                <div class="badge"><span id="lbl_cat_rank">Cat Rank</span><strong id="an_cat_rank">-</strong></div>
                <div class="badge"><span id="lbl_gen_rank">Gen Rank</span><strong id="an_gen_rank">-</strong></div>
                <div class="badge"><span id="lbl_mix_rank">Mix Rank</span><strong id="an_cat_gen_rank">-</strong></div>
            </div>

            <div class="range-filter-box">
                <span class="range-label">Analyze Range:</span>
                <input type="number" id="range_start" class="range-inp" placeholder="Start">
                <span style="font-weight:bold; color:#aaa;">-</span>
                <input type="number" id="range_end" class="range-inp" placeholder="End">
                <button class="range-btn" onclick="updateStatsByRange()">Go</button>
            </div>

            <div class="sec-title" style="margin-top:0;">
                <span id="overall-header">üåê Overall Stats (Range)</span>
            </div>
            <div class="table-wrapper">
                <table class="stats-table">
                    <thead>
                        <tr>
                            <th class="col-cat">Category</th>
                            <th class="col-data">Male</th>
                            <th class="col-data">Fem</th>
                            <th class="col-data">Oth</th>
                            <th class="col-data tsp-head">TSP</th>
                            <th class="col-data">Total</th>
                        </tr>
                    </thead>
                    <tbody id="overall-table-body"></tbody>
                </table>
            </div>

            <div class="shift-section-wrapper">
                <div class="sec-title shift-color">
                    <span id="shift-header-text">‚ö° Shift Statistics</span>
                </div>
                <div class="rank-badges">
                    <div class="badge b-shift"><span>Shift Rank</span><strong id="sh_merit">-</strong></div>
                    <div class="badge b-shift"><span id="lbl_sh_cat">Shift Cat</span><strong id="sh_cat_rank">-</strong></div>
                    <div class="badge b-shift"><span id="lbl_sh_gen">Shift Gen</span><strong id="sh_gen_rank">-</strong></div>
                    <div class="badge b-shift"><span id="lbl_sh_mix">Shift Mix</span><strong id="sh_cat_gen_rank">-</strong></div>
                </div>

                <div class="table-wrapper" style="border-top: 2px solid var(--accent);">
                    <table class="stats-table">
                        <thead>
                            <tr>
                                <th class="col-cat" style="background: #f3e5f5; color: #4a148c;">Category</th>
                                <th class="col-data" style="background: #f3e5f5; color: #4a148c;">Male</th>
                                <th class="col-data" style="background: #f3e5f5; color: #4a148c;">Fem</th>
                                <th class="col-data" style="background: #f3e5f5; color: #4a148c;">Oth</th>
                                <th class="col-data tsp-head" style="background: #fffbfb !important;">TSP</th>
                                <th class="col-data" style="background: #f3e5f5; color: #4a148c;">Total</th>
                            </tr>
                        </thead>
                        <tbody id="shift-table-body"></tbody>
                    </table>
                </div>
            </div>

            <div style="text-align: center; margin-top: 25px;">
                <button onclick="window.print()" style="background: #28a745; border:none; color:white; padding: 8px 20px; border-radius: 50px; font-size: 0.8rem; cursor: pointer; display: inline-flex; align-items: center; gap: 6px;">
                    üñ®Ô∏è Print Report
                </button>
            </div>
        </div>
    </div>

    <footer>&copy; 2026 Dream-Link Analytics</footer>

    <script src="data_roll_ntsp_part1.js"></script>
    <script src="data_roll_ntsp_part2.js"></script>
    <script src="data_ntsp_merit_part1.js"></script>
    <script src="data_merit_part2.js"></script>

    <script>
        const CAT_ORDER = ["GEN", "OBC", "EWS", "MBC", "SC", "ST", "SAH"];
        const SUB_TYPES = [
            { key: "EXM", label: "Ex-Serviceman" },
            { key: "LDCP", label: "LDCP/PH" },
            { key: "SP", label: "Sports Person" },
            { key: "DV", label: "Divorcee" },
            { key: "WD", label: "Widow" }
        ];

        let GLOBAL_MERIT_DB = {};
        let CURRENT_CANDIDATE_SHIFT = "";
        let CURRENT_CANDIDATE_MERIT = 0;

        function processResult() {
            const roll = document.getElementById('rollInput').value.trim();
            const status = document.getElementById('status-msg');
            const resArea = document.getElementById('result-area');
            const anArea = document.getElementById('analyzer-area');

            resArea.style.display = 'none';
            anArea.style.display = 'none';
            status.innerHTML = 'Wait...';
            status.style.color = 'orange';

            if(!roll) { status.innerHTML = "Enter Roll Number"; status.style.color = 'red'; return; }

            setTimeout(() => {
                const rollDB = window.NTSP_ROLL_DATA || {};
                GLOBAL_MERIT_DB = window.NTSP_MERIT_DATA || {}; 

                const candidate = rollDB[roll];

                if (!candidate) {
                    status.innerHTML = `Roll Not Found`;
                    status.style.color = 'red';
                    return;
                }

                const myMerit = parseInt(candidate.Merit);
                CURRENT_CANDIDATE_MERIT = myMerit;
                const myDetails = GLOBAL_MERIT_DB[myMerit] || {};
                
                const myCat = (myDetails.Category || "OTHER").toUpperCase();
                const myGen = (myDetails.Gender || "OTHER").toUpperCase();
                const myShift = String(myDetails.Shift);
                CURRENT_CANDIDATE_SHIFT = myShift;

                // Basic UI
                document.getElementById('d_roll').innerText = roll;
                document.getElementById('d_name').innerText = candidate.Name;
                document.getElementById('d_father').innerText = candidate.Father;
                document.getElementById('d_mother').innerText = candidate.Mother; // Show Mother
                document.getElementById('d_raw').innerText = candidate.RawMark;
                document.getElementById('d_final').innerText = candidate.FinalMark;
                document.getElementById('d_merit').innerText = myMerit;
                document.getElementById('d_cat').innerText = myCat;
                document.getElementById('d_gender').innerText = myGen;
                document.getElementById('d_shift').innerText = "Shift " + myShift;

                // --- Calculate Right Que ---
                let rawVal = parseFloat(candidate.RawMark);
                let rightQ = "N/A";
                if(!isNaN(rawVal)) {
                    rightQ = (rawVal / 1.66).toFixed(2);
                }
                document.getElementById('d_rightq').innerText = rightQ;

                // Labels
                document.getElementById('lbl_cat_rank').innerText = `${myCat}`;
                document.getElementById('lbl_gen_rank').innerText = `${myGen}`;
                document.getElementById('lbl_mix_rank').innerText = `${myCat}+${myGen.charAt(0)}`;
                document.getElementById('lbl_sh_cat').innerText = `Sh ${myCat}`;
                document.getElementById('lbl_sh_gen').innerText = `Sh ${myGen}`;
                document.getElementById('lbl_sh_mix').innerText = `Mix Rank`;
                document.getElementById('shift-header-text').innerText = `‚ö° Shift ${myShift} Statistics`;

                document.getElementById('range_start').value = 1;
                document.getElementById('range_end').value = myMerit;

                calculateBadges(myMerit, myCat, myGen, myShift);
                calculateTables(1, myMerit, myShift);

                status.innerHTML = "";
                resArea.style.display = 'block';
                anArea.style.display = 'block';

            }, 100);
        }

        function updateStatsByRange() {
            let start = parseInt(document.getElementById('range_start').value) || 1;
            let end = parseInt(document.getElementById('range_end').value) || CURRENT_CANDIDATE_MERIT;
            if(start > end) { alert("Invalid Range"); return; }
            
            document.getElementById('overall-header').innerText = `üåê Overall Stats (Rank ${start} to ${end})`;
            document.getElementById('shift-header-text').innerText = `‚ö° Shift ${CURRENT_CANDIDATE_SHIFT} Stats (Rank ${start} to ${end})`;
            calculateTables(start, end, CURRENT_CANDIDATE_SHIFT);
        }

        function calculateBadges(limit, myCat, myGen, myShift) {
            let gBadges = { cat: 0, gen: 0, mix: 0 };
            let sBadges = { rank: 0, cat: 0, gen: 0, mix: 0 };

            for (let i = 1; i <= limit; i++) {
                const p = GLOBAL_MERIT_DB[i];
                if (!p) continue;

                let pCat = (p.Category || "OTHER").toUpperCase();
                if (!CAT_ORDER.includes(pCat)) pCat = "OTHER";
                let pGen = (p.Gender || "OTHER").toUpperCase();
                let pShift = String(p.Shift);

                if (pCat === myCat) gBadges.cat++;
                if (pGen === myGen) gBadges.gen++;
                if (pCat === myCat && pGen === myGen) gBadges.mix++;

                if (pShift === myShift) {
                    sBadges.rank++;
                    if (pCat === myCat) sBadges.cat++;
                    if (pGen === myGen) sBadges.gen++;
                    if (pCat === myCat && pGen === myGen) sBadges.mix++;
                }
            }
            document.getElementById('an_merit').innerText = limit;
            document.getElementById('an_cat_rank').innerText = gBadges.cat;
            document.getElementById('an_gen_rank').innerText = gBadges.gen;
            document.getElementById('an_cat_gen_rank').innerText = gBadges.mix;

            document.getElementById('sh_merit').innerText = sBadges.rank;
            document.getElementById('sh_cat_rank').innerText = sBadges.cat;
            document.getElementById('sh_gen_rank').innerText = sBadges.gen;
            document.getElementById('sh_cat_gen_rank').innerText = sBadges.mix;
        }

        function calculateTables(start, end, myShift) {
            const createCatStat = () => ({
                m: 0, f: 0, o: 0, tot: 0, tsp: 0,
                subs: { "EXM": z(), "LDCP": z(), "SP": z(), "DV": z(), "WD": z() }
            });
            const z = () => ({ m: 0, f: 0, o: 0, tot: 0, tsp: 0 });

            let globalM = {};
            let shiftM = {};
            [...CAT_ORDER, "OTHER"].forEach(c => {
                globalM[c] = createCatStat();
                shiftM[c] = createCatStat();
            });

            for (let i = start; i <= end; i++) {
                const p = GLOBAL_MERIT_DB[i];
                if (!p) continue;

                let pCat = (p.Category || "OTHER").toUpperCase();
                if (!CAT_ORDER.includes(pCat)) pCat = "OTHER";
                let pGen = (p.Gender || "OTHER").toUpperCase();
                let pShift = String(p.Shift);
                let pSub = (p.SubCat || "").toUpperCase();
                let pTsp = (p.TSP || "").toUpperCase().includes("YES") || (p.TSP || "").toUpperCase().includes("TSP");

                const updateRow = (matrix) => {
                    let row = matrix[pCat];
                    if (pGen === 'MALE') row.m++;
                    else if (pGen === 'FEMALE') row.f++;
                    else row.o++;
                    row.tot++;
                    if (pTsp) row.tsp++;

                    SUB_TYPES.forEach(sub => {
                        if (pSub.includes(sub.key) || (sub.key === "LDCP" && (pSub.includes("BL") || pSub.includes("LD")))) {
                            let sRow = row.subs[sub.key];
                            if (pGen === 'MALE') sRow.m++;
                            else if (pGen === 'FEMALE') sRow.f++;
                            else sRow.o++;
                            sRow.tot++;
                            if (pTsp) sRow.tsp++;
                        }
                    });
                };

                updateRow(globalM);
                if (pShift === myShift) {
                    updateRow(shiftM);
                }
            }

            renderDeepTable("overall-table-body", globalM);
            renderDeepTable("shift-table-body", shiftM);
        }

        function renderDeepTable(id, data) {
            const tbody = document.getElementById(id);
            tbody.innerHTML = "";
            
            // Grand Total Tracker
            let gTotal = { m:0, f:0, o:0, tsp:0, all:0 };

            [...CAT_ORDER, "OTHER"].forEach(cat => {
                const d = data[cat];
                if (d.tot === 0) return;

                // Add to Grand Total
                gTotal.m += d.m;
                gTotal.f += d.f;
                gTotal.o += d.o;
                gTotal.tsp += d.tsp;
                gTotal.all += d.tot;

                let html = `
                    <tr style="background:#fff;">
                        <td class="col-cat"><span class="cat-tag bg-${cat}">${cat}</span></td>
                        <td>${d.m}</td>
                        <td>${d.f}</td>
                        <td>${d.o}</td>
                        <td class="tsp-cell">${d.tsp}</td>
                        <td class="row-total">${d.tot}</td>
                    </tr>
                `;

                SUB_TYPES.forEach(sub => {
                    let sd = d.subs[sub.key];
                    if (sd.tot > 0) {
                        html += `
                            <tr class="sub-row">
                                <td class="col-cat sub-label"><span class="sub-icon">‚Ü≥</span> ${sub.label}</td>
                                <td>${sd.m || ""}</td>
                                <td>${sd.f || ""}</td>
                                <td>${sd.o || ""}</td>
                                <td class="tsp-cell">${sd.tsp || ""}</td>
                                <td>${sd.tot}</td>
                            </tr>
                        `;
                    }
                });
                tbody.innerHTML += html;
            });

            // APPEND GRAND TOTAL ROW
            if(gTotal.all > 0) {
                tbody.innerHTML += `
                    <tr class="grand-total-row">
                        <td class="col-cat">GRAND TOTAL</td>
                        <td>${gTotal.m}</td>
                        <td>${gTotal.f}</td>
                        <td>${gTotal.o}</td>
                        <td class="tsp-cell" style="font-weight:800; color:#1a237e;">${gTotal.tsp}</td>
                        <td>${gTotal.all}</td>
                    </tr>
                `;
            }
        }
    </script>
</body>
</html>