<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Dream-Link 4th LOADING AI</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary: #0056b3;
            --accent: #6f42c1;
            --bg: #f0f2f5;
            --text: #333;
            --radius: 6px;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--bg);
            margin: 0;
            padding: 0;
            color: var(--text);
            -webkit-font-smoothing: antialiased;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        /* --- PREMIUM LOADER STYLES --- */
        .loader-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(5px);
            z-index: 9999;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            transition: opacity 0.3s ease;
        }

        .loader-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #e0e0e0;
            border-top: 5px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }

        .loader-text {
            font-weight: 600;
            color: var(--primary);
            font-size: 1rem;
            text-align: center;
            max-width: 80%;
        }

        .loader-subtext {
            font-size: 0.8rem;
            color: #666;
            margin-top: 5px;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* COMPACT HEADER */
        header {
            background: linear-gradient(135deg, #0056b3, #004494);
            color: white;
            padding: 8px 0;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        header h1 {
            margin: 0;
            font-size: 1.1rem;
            letter-spacing: 0.5px;
        }

        .sub-head {
            font-size: 0.7rem;
            opacity: 0.9;
            margin-top: 1px;
            font-weight: 400;
        }

        /* ULTRA COMPACT CONTAINER */
        .container {
            max-width: 600px;
            margin: 5px auto;
            padding: 5px;
            background: white;
            border-radius: var(--radius);
            width: 98%;
            box-sizing: border-box;
            flex: 1;
        }

        /* COMPACT TOGGLE */
        .mode-toggle {
            display: flex;
            background: #e9ecef;
            border-radius: 50px;
            padding: 3px;
            margin-bottom: 10px;
        }

        .toggle-btn {
            flex: 1;
            border: none;
            background: transparent;
            padding: 8px;
            border-radius: 50px;
            cursor: pointer;
            font-weight: 600;
            color: #666;
            transition: 0.3s;
            font-size: 0.8rem;
        }

        .toggle-btn.active {
            background: white;
            color: var(--primary);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        /* COMPACT INPUTS */
        .input-section {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .input-section.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(5px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .search-inputs {
            display: flex;
            gap: 5px;
            margin-bottom: 10px;
        }

        .form-group {
            flex: 1;
        }

        select,
        input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: var(--radius);
            font-size: 0.85rem;
            box-sizing: border-box;
            outline: none;
            background: #fafafa;
            height: 38px;
        }

        select:focus,
        input:focus {
            border-color: var(--primary);
            background: #fff;
        }

        .main-btn {
            width: 100%;
            padding: 10px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: var(--radius);
            cursor: pointer;
            font-weight: 600;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: 0.2s;
            margin-bottom: 5px;
        }

        .analyze-btn {
            background: var(--accent);
        }

        .main-btn:active {
            transform: scale(0.98);
        }

        .range-row {
            display: flex;
            align-items: center;
            gap: 5px;
            margin-bottom: 10px;
        }

        .range-inp-home {
            flex: 1;
            text-align: center;
            font-weight: bold;
        }

        /* RESULT AREA */
        .result-container {
            display: none;
            margin-top: 10px;
        }

        /* COMPACT SCORE CARD */
        .res-card {
            border: 1px solid #eee;
            border-radius: var(--radius);
            overflow: hidden;
            background: #fff;
            margin-bottom: 15px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }

        .res-header {
            background: #e3f2fd;
            padding: 6px;
            text-align: center;
            font-size: 0.85rem;
            color: var(--primary);
            font-weight: 700;
            border-bottom: 1px solid #bbdefb;
        }

        .compact-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            font-size: 0.75rem;
        }

        .c-row {
            padding: 4px 8px;
            border-bottom: 1px solid #f5f5f5;
            display: flex;
            align-items: center;
            min-height: 24px;
        }

        .c-row:not([style*="span 2"]):nth-child(odd) {
            border-right: 1px solid #f5f5f5;
        }

        .c-label {
            color: #666;
            font-weight: 500;
            width: 75px;
            flex-shrink: 0;
            font-size: 0.7rem;
        }

        .c-val {
            font-weight: 700;
            color: #222;
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            font-size: 0.75rem;
        }

        .c-highlight {
            color: var(--primary);
            font-weight: 800;
        }

        .c-row[style*="span 2"] .c-val {
            white-space: normal;
        }

        /* INNER TOOLBAR */
        .inner-toolbar {
            background: #f8f9fa;
            border: 1px solid #eee;
            padding: 6px;
            border-radius: var(--radius);
            margin-bottom: 15px;
            display: flex;
            justify-content: center;
            gap: 5px;
            align-items: center;
            font-size: 0.75rem;
        }

        .mini-inp {
            width: 90px;
            padding: 4px;
            text-align: center;
            font-weight: bold;
            border: 1px solid #ccc;
            border-radius: 3px;
            font-size: 0.75rem;
        }

        .mini-btn {
            padding: 4px 10px;
            border-radius: 3px;
            background: var(--accent);
            color: white;
            border: none;
            cursor: pointer;
            font-size: 0.75rem;
        }

        .refresh-icon-btn {
            background: #28a745;
            width: 26px;
            height: 26px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            border: none;
            cursor: pointer;
            font-size: 0.9rem;
        }

        /* COMPACT TABLES */
        .sec-title {
            font-size: 0.85rem;
            font-weight: 700;
            color: #333;
            margin: 15px 0 5px 0;
            border-left: 3px solid var(--primary);
            padding-left: 6px;
            page-break-after: avoid;
        }

        .shift-color {
            border-color: var(--accent);
            color: var(--accent);
        }

        .rank-table-wrapper {
            border: 1px solid #ddd;
            border-radius: var(--radius);
            overflow: hidden;
            margin-bottom: 15px;
            transition: opacity 0.3s;
            page-break-inside: avoid;
        }

        table.rank-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.75rem;
        }

        table.rank-table th {
            background: #0056b3;
            color: white;
            padding: 5px;
            text-align: center;
            font-weight: 500;
            border-right: 1px solid rgba(255, 255, 255, 0.2);
            font-size: 0.7rem;
            white-space: normal;
            vertical-align: bottom;
        }

        table.rank-table th:first-child {
            text-align: left;
            padding-left: 10px;
            width: 45%;
        }

        table.rank-table td {
            padding: 5px;
            text-align: center;
            border-bottom: 1px solid #eee;
            color: #333;
            font-weight: 600;
            font-size: 0.75rem;
            white-space: normal;
        }

        table.rank-table td:first-child {
            text-align: left;
            padding-left: 10px;
            color: #555;
            background: #f9f9f9;
            border-right: 1px solid #eee;
        }

        .shift-rank-table th {
            background: var(--accent);
        }

        .table-wrapper {
            overflow-x: auto;
            border: 1px solid #eee;
            border-radius: var(--radius);
            margin-bottom: 15px;
            background: white;
            page-break-inside: avoid;
        }

        table.stats-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.65rem;
            min-width: 100%;
        }

        .stats-table th {
            background: #f8f9fa;
            color: #555;
            font-weight: 700;
            text-transform: uppercase;
            padding: 5px 3px;
            text-align: center;
            border-bottom: 2px solid #ddd;
            font-size: 0.6rem;
            white-space: normal;
            vertical-align: bottom;
            line-height: 1.1;
            border: 1px solid #eee;
        }

        .ntsp-header {
            background: #e3f2fd !important;
            color: #0277bd !important;
            border-bottom: none !important;
        }

        .tsp-super-header {
            background: #fff3e0 !important;
            color: #ef6c00 !important;
        }

        .stats-table td {
            padding: 4px 2px;
            border-bottom: 1px solid #f0f0f0;
            text-align: center;
            color: #444;
            font-weight: 500;
            white-space: normal;
            border-right: 1px solid #f9f9f9;
        }

        .col-cat {
            width: 22%;
            text-align: left !important;
            padding-left: 5px !important;
        }

        .cat-tag {
            display: inline-block;
            padding: 1px 4px;
            border-radius: 3px;
            color: white;
            font-size: 0.6rem;
            font-weight: bold;
            min-width: 30px;
            text-align: center;
        }

        .bg-GEN {
            background-color: #6c757d;
        }

        .bg-OBC {
            background-color: #007bff;
        }

        .bg-EWS {
            background-color: #17a2b8;
        }

        .bg-MBC {
            background-color: #6610f2;
        }

        .bg-SC {
            background-color: #e83e8c;
        }

        .bg-ST {
            background-color: #fd7e14;
        }

        .bg-SAH {
            background-color: #28a745;
        }

        .sub-row td {
            background-color: #fcfcfc;
            color: #666;
            font-size: 0.6rem;
            border-bottom: 1px dashed #eee;
        }

        .grand-total-row td {
            background-color: #e8eaf6;
            color: #1a237e;
            font-weight: 800;
            border-top: 1px solid #c5cae9;
        }

        .dynamic-shift-label {
            background: #f3e5f5;
            color: #4a148c;
            padding: 6px;
            font-weight: 700;
            border-bottom: 2px solid #d1c4e9;
            border-radius: var(--radius) var(--radius) 0 0;
            margin-bottom: -1px;
            font-size: 0.8rem;
        }

        /* FOOTER & BUTTONS */
        .home-action-area {
            text-align: center;
            margin-top: auto;
            padding: 15px 0 5px 0;
            width: 100%;
        }

        .print-btn {
            background-color: #28a745;
            color: white;
            border: none;
            padding: 8px 20px;
            border-radius: 50px;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            box-shadow: 0 3px 8px rgba(40, 167, 69, 0.3);
            margin: 10px auto;
            display: block;
        }

        .telegram-btn {
            display: inline-block;
            background-color: #f1f3f5;
            color: #adb5bd;
            text-decoration: none;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 0.65rem;
            font-weight: 500;
            border: 1px solid #e9ecef;
            transition: 0.2s;
        }

        .telegram-btn:hover {
            background-color: #e9ecef;
            color: #495057;
        }

        footer {
            text-align: center;
            padding: 10px;
            font-size: 0.65rem;
            color: #aaa;
            border-top: 1px solid #eee;
            background: #fff;
            margin-top: 0;
        }

        @media print {

            /* 1. Hide unwanted elements */
            header,
            .mode-toggle,
            .input-section,
            .inner-toolbar,
            .print-btn,
            .telegram-btn,
            footer,
            .home-action-area,
            #status-msg,
            .loader-overlay {
                display: none !important;
            }

            /* 2. Basic Setup (Use Flexbox to Reorder) */
            body {
                background: white;
                margin: 0;
                padding: 0;
                font-size: 10pt;
            }

            /* Container ko Flex banayenge taaki Order change kar sakein */
            .container {
                display: flex !important;
                flex-direction: column !important;
                padding: 0;
                margin: 0;
                max-width: 100%;
                border: none;
                box-shadow: none;
                width: 100%;
            }

            /* Header sabse upar (Order 1) */
            #print-header {
                display: block !important;
                text-align: center;
                border-bottom: 2px solid #000;
                margin-bottom: 10px;
                padding-bottom: 5px;
                order: 1;
            }

            /* Results beech me (Order 2) */
            .result-container[style*="block"] {
                display: block !important;
                order: 2;
            }

            .result-container[style*="none"] {
                display: none !important;
            }

            /* 3. CUTOFF TABLE PRINT DESIGN (Professional Look) */
            #cutoff-display-area {
                display: block !important;
                order: 9999 !important;
                /* ‡§™‡•á‡§ú ‡§ï‡•á ‡§Ö‡§Ç‡§§ ‡§Æ‡•á‡§Ç */
                margin-top: 25px !important;
                border: none !important;
                /* ‡§™‡•Å‡§∞‡§æ‡§®‡§æ ‡§°‡•à‡§∂ ‡§¨‡•â‡§∞‡•ç‡§°‡§∞ ‡§π‡§ü‡§æ‡§Ø‡§æ */
                background: transparent !important;
                opacity: 1 !important;
                /* ‡§ß‡•Å‡§Ç‡§ß‡§≤‡§æ‡§™‡§® ‡§π‡§ü‡§æ‡§Ø‡§æ */
                filter: none !important;
                width: 100% !important;
                page-break-inside: avoid !important;
                padding: 0 !important;
            }

            /* Header ‡§ï‡•ã Section Title ‡§ú‡•à‡§∏‡§æ ‡§¨‡§®‡§æ‡§è‡§Ç */
            .cutoff-header {
                text-align: left !important;
                /* Center ‡§∏‡•á Left ‡§ï‡§ø‡§Ø‡§æ */
                font-size: 0.85rem !important;
                font-weight: 700 !important;
                color: #000 !important;
                /* ‡§ó‡§π‡§∞‡§æ ‡§ï‡§æ‡§≤‡§æ */
                border-bottom: 3px solid #000 !important;
                /* ‡§®‡•Ä‡§ö‡•á ‡§≤‡§æ‡§á‡§® */
                margin-bottom: 5px !important;
                padding-left: 5px !important;
                letter-spacing: normal !important;
            }

            /* Table ‡§ï‡•ã ‡§¨‡§æ‡§ï‡•Ä ‡§ü‡•á‡§¨‡§≤‡•ç‡§∏ ‡§ú‡•à‡§∏‡§æ ‡§∏‡•â‡§≤‡§ø‡§° ‡§¨‡§®‡§æ‡§è‡§Ç */
            .cutoff-table {
                width: 100% !important;
                border-collapse: collapse !important;
                border: 1px solid #000 !important;
                font-size: 7pt !important;
            }

            .cutoff-table th {
                background: #f0f0f0 !important;
                color: #000 !important;
                border: 1px solid #000 !important;
                padding: 4px !important;
                text-align: center !important;
            }

            .cutoff-table td {
                color: #000 !important;
                border: 1px solid #000 !important;
                padding: 3px !important;
                text-align: center !important;
            }

            /* Category Column (First) Styling */
            .cutoff-table td:first-child {
                background: #f9f9f9 !important;
                color: #000 !important;
                text-align: left !important;
                font-weight: 800 !important;
                padding-left: 8px !important;
                border-right: 1px solid #000 !important;
            }

            /* Bottom Tags (LD/CP etc) Styling */
            .hz-row {
                justify-content: flex-start !important;
                /* Left Align */
                margin-top: 8px !important;
                gap: 10px !important;
            }

            .hz-tag {
                border: 1px solid #000 !important;
                color: #000 !important;
                background: white !important;
                font-weight: bold !important;
                padding: 2px 8px !important;
            }

            /* 4. Page Break Safety */
            .sec-title,
            .cutoff-header,
            .res-header,
            .dynamic-shift-label {
                page-break-after: avoid !important;
                break-after: avoid !important;
            }

            .res-card,
            .rank-table-wrapper,
            .table-wrapper,
            .cutoff-table-wrapper,
            .dynamic-shift-wrapper {
                page-break-inside: avoid !important;
                break-inside: avoid !important;
                margin-bottom: 15px;
            }

            tr,
            td,
            th {
                page-break-inside: avoid !important;
            }
        }

        /* CUTOFF TABLE STYLES (Watermark Look) */
        #cutoff-display-area {
            margin-top: 25px;
            background: rgba(255, 255, 255, 0.4);
            /* ‡§¨‡§π‡•Å‡§§ ‡§π‡§≤‡•ç‡§ï‡§æ ‡§¨‡•à‡§ï‡§ó‡•ç‡§∞‡§æ‡§â‡§Ç‡§° */
            border: 2px dashed #ddd;
            /* ‡§ü‡•Ç‡§ü‡•Ä ‡§π‡•Å‡§à ‡§≤‡§æ‡§á‡§® */
            border-radius: var(--radius);
            padding: 10px;
            opacity: 0.5;
            /* 50% ‡§ß‡•Å‡§Ç‡§ß‡§≤‡§æ (Watermark ‡§ú‡•à‡§∏‡§æ) */
            filter: grayscale(100%);
            /* ‡§∞‡§Ç‡§ó ‡§π‡§ü‡§æ ‡§¶‡•á‡§Ç (Grey look) */
            transition: 0.3s;
            pointer-events: none;
            /* ‡§á‡§∏ ‡§™‡§∞ ‡§ï‡•ç‡§≤‡§ø‡§ï ‡§® ‡§π‡•ã (Optional) */
        }

        /* ‡§ú‡§¨ ‡§Æ‡§æ‡§â‡§∏ ‡§≤‡•á ‡§ú‡§æ‡§è‡§Ç ‡§§‡•ã ‡§∏‡§æ‡•û ‡§¶‡§ø‡§ñ‡•á */
        #cutoff-display-area:hover {
            opacity: 1;
            filter: none;
            background: white;
            border-style: solid;
            pointer-events: auto;
        }

        .cutoff-header {
            text-align: center;
            font-size: 0.8rem;
            font-weight: 700;
            color: #888;
            margin-bottom: 8px;
            letter-spacing: 0.5px;
            text-transform: uppercase;
        }

        .cutoff-table-wrapper {
            overflow-x: auto;
        }

        .cutoff-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.65rem;
        }

        .cutoff-table th {
            background: #f1f1f1;
            padding: 4px;
            text-align: center;
            border: 1px solid #ddd;
            color: #777;
        }

        .cutoff-table td {
            padding: 4px;
            text-align: center;
            border: 1px solid #eee;
            color: #555;
            font-weight: 600;
        }

        .cutoff-table tr:nth-child(even) {
            background: #f9f9f9;
        }

        .cutoff-table td:first-child {
            background: #6c757d;
            color: white;
            font-weight: 500;
            text-align: left;
            padding-left: 6px;
            width: 40px;
        }

        .hz-row {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 8px;
            flex-wrap: wrap;
        }

        .hz-tag {
            background: #eee;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 0.7rem;
            border: 1px solid #ccc;
            font-weight: bold;
            color: #666;
        }
    </style>
</head>

<body>

    <div id="global-loader" class="loader-overlay">
        <div class="loader-spinner"></div>
        <div id="loader-msg" class="loader-text">Processing...</div>
        <div id="loader-sub" class="loader-subtext">Please wait</div>
    </div>

    <header>
        <h1>Dream-Link 4th Grade Results</h1>
        <div class="sub-head">Analyse by MP SALODIYA</div>
    </header>

    <div class="container">

        <div id="print-header" style="display: none;">
            <h3>Dream-Link Results</h3>
            <p style="font-size: 0.9rem;">Analyse by MP SALODIYA</p>
        </div>

        <div class="mode-toggle">
            <button class="toggle-btn active" onclick="switchMode('analyze')">üìä Rank Analyse</button>
            <button class="toggle-btn" onclick="switchMode('search')">üîç Search Result</button>
        </div>
        <div id="input-search" class="input-section">
            <div class="search-inputs">
                <div class="form-group" style="flex: 0.6;">
                    <select id="examTypeSearch">
                        <option value="NTSP">NTSP</option>
                        <option value="TSP">TSP</option>
                    </select>
                </div>
                <div class="form-group" style="flex: 1.4;">
                    <input type="number" id="rollInput" placeholder="Enter Roll Number">
                </div>
            </div>
            <button class="main-btn" onclick="executeSearch()">Check Result</button>
        </div>


        <div id="input-analyze" class="input-section active">

            <div class="search-inputs">

                <div class="form-group" style="flex: 0.6;">
                    <select id="examTypeAnalyze">
                        <option value="NTSP">NTSP</option>
                        <option value="TSP">TSP</option>
                    </select>
                </div>

                <div class="form-group" style="flex: 1.4; display: flex; gap: 5px;">
                    <input type="number" id="ana_start" placeholder="Start" style="width: 50%; padding: 8px;">
                    <input type="number" id="ana_end" placeholder="End" style="width: 50%; padding: 8px;">
                </div>
            </div>
            <button class="main-btn analyze-btn" onclick="executeAnalyze()">Analyze Stats üöÄ</button>
        </div>
        <div id="cutoff-display-area">
            <div class="cutoff-header">
                <span id="cutoff-title">üèÜ NTSP OFFICIAL CUTOFF (PRE DV)</span>
            </div>
            <div class="cutoff-table-wrapper">
                <table class="cutoff-table" id="cutoff-table-body">
                </table>
            </div>
            <div id="hz-cutoff-row" class="hz-row"></div>
        </div>

        <div id="status-msg" style="text-align: center; margin-top: 10px; font-weight: 600; font-size: 0.8rem; min-height: 18px;"></div>

        <div id="result-search" class="result-container">
            <div class="res-card">
                <div class="res-header">CANDIDATE SCORE CARD</div>
                <div class="compact-grid">
                    <div class="c-row">
                        <div class="c-label">Roll No</div>
                        <div class="c-val" id="d_roll">-</div>
                    </div>
                    <div class="c-row">
                        <div class="c-label">Category</div>
                        <div class="c-val" id="d_cat">-</div>
                    </div>
                    <div class="c-row" style="grid-column: span 2;">
                        <div class="c-label">Name</div>
                        <div class="c-val" id="d_name">-</div>
                    </div>
                    <div class="c-row" style="grid-column: span 2;">
                        <div class="c-label">Father</div>
                        <div class="c-val" id="d_father">-</div>
                    </div>
                    <div class="c-row" style="grid-column: span 2;">
                        <div class="c-label">Mother</div>
                        <div class="c-val" id="d_mother">-</div>
                    </div>
                    <div class="c-row">
                        <div class="c-label">Gender</div>
                        <div class="c-val" id="d_gender">-</div>
                    </div>
                    <div class="c-row">
                        <div class="c-label">Special Cat</div>
                        <div class="c-val" id="d_subcat">-</div>
                    </div>
                    <div class="c-row">
                        <div class="c-label">TSP Status</div>
                        <div class="c-val" id="d_tsp">-</div>
                    </div>
                    <div class="c-row">
                        <div class="c-label">Shift</div>
                        <div class="c-val" id="d_shift">-</div>
                    </div>
                    <div class="c-row" style="background: #f8f9fa;">
                        <div class="c-label">Exam Date</div>
                        <div class="c-val" id="d_exam_date">-</div>
                    </div>
                    <div class="c-row" style="background: #f8f9fa;">
                        <div class="c-label">Total Cand.</div>
                        <div class="c-val" id="d_total_cands">-</div>
                    </div>
                    <div class="c-row" style="background: #fdf2f2;">
                        <div class="c-label">Present</div>
                        <div class="c-val" id="d_present">-</div>
                    </div>
                    <div class="c-row" style="background: #fdf2f2;">
                        <div class="c-label">Absent</div>
                        <div class="c-val" id="d_absent">-</div>
                    </div>
                    <div class="c-row">
                        <div class="c-label">Raw Marks</div>
                        <div class="c-val" id="d_raw">-</div>
                    </div>
                    <div class="c-row">
                        <div class="c-label">Right Que</div>
                        <div class="c-val" id="d_rightq" style="color: green;">-</div>
                    </div>

                    <div class="c-row" style="background:#f0f8ff;">
                        <div class="c-label">Final Marks</div>
                        <div class="c-val c-highlight" id="d_final">-</div>
                    </div>
                    <div class="c-row" style="background:#f0f8ff;">
                        <div class="c-label">Diff.</div>
                        <div class="c-val" id="d_diff" style="font-weight:bold;">-</div>
                    </div>

                    <div class="c-row" style="grid-column: span 2; background: #fffbe6; justify-content: center; gap: 8px; border-top: 1px solid #e0e0e0; padding: 8px;">
                        <span class="c-label" style="font-size: 0.8rem; width: auto;">OVERALL MERIT RANK:</span>
                        <span class="c-val c-highlight" style="font-size: 1.1rem; max-width: none; flex: initial;" id="d_merit">-</span>
                    </div>
                </div>
            </div>

            <div class="inner-toolbar">
                <span>Rank:</span>
                <input type="number" id="res_start" class="mini-inp" placeholder="Start">
                <span>-</span>
                <input type="number" id="res_end" class="mini-inp" placeholder="End">
                <button class="mini-btn" onclick="updateSearchResult()">Go</button>
                <button class="refresh-icon-btn" onclick="resetSearchAnalysis()">‚Üª</button>
            </div>

            <div class="sec-title" style="margin-top: 0;">üìä Deep Merit Analysis</div>
            <div class="rank-table-wrapper" id="rt-wrapper-1">
                <table class="rank-table">
                    <thead>
                        <tr>
                            <th>Criteria</th>
                            <th>Rank (With TSP)</th>
                            <th>Rank (NTSP Only)</th>
                        </tr>
                    </thead>
                    <tbody id="tb-overall-rank"></tbody>
                </table>
            </div>

            <div class="sec-title"><span id="lbl-ov-stats">üåê Overall Stats</span></div>
            <div class="table-wrapper" id="rt-wrapper-2">
                <table class="stats-table" id="tb-overall-stats"></table>
            </div>

            <div id="search-shift-section">
                <div class="sec-title shift-color"><span id="lbl-sh-stats">‚ö° Shift Statistics</span></div>
                <div class="rank-table-wrapper" id="rt-wrapper-3">
                    <table class="rank-table shift-rank-table">
                        <thead>
                            <tr>
                                <th>Criteria</th>
                                <th>Shift Rank (All)</th>
                                <th>Shift Rank (NTSP)</th>
                            </tr>
                        </thead>
                        <tbody id="tb-shift-rank"></tbody>
                    </table>
                </div>
                <div class="table-wrapper" id="rt-wrapper-4">
                    <table class="stats-table" id="tb-shift-stats"></table>
                </div>
            </div>

            <button class="print-btn" onclick="window.print()">üñ®Ô∏è Print Result</button>
        </div>

        <div id="result-analyze" class="result-container">
            <div class="sec-title" style="margin-top: 0;"><span id="ana-ov-header">üåê Overall Stats Range Analysis</span></div>
            <div id="ana-overall-container"></div>

            <div class="sec-title shift-color">‚ö° Multi-Shift Analysis</div>
            <div id="ana-shifts-container"></div>

            <button class="print-btn" onclick="window.print()">üñ®Ô∏è Print Stats</button>
        </div>

        <div class="home-action-area">
            <a href="https://t.me/YOUR_LINK_HERE" class="telegram-btn" target="_blank">Join Telegram</a>
        </div>

    </div>

    <footer>&copy; 2026 Dream-Link MP SALODIYA</footer>

    <script src="cutoff_data.js"></script>


    <script>
        // --- 1. SMART FILE LISTS ---

        // NTSP ROLL DATA FILES
        const ROLL_FILES_NTSP = [
            "data_roll_ntsp_part1.js",
            "data_roll_ntsp_part2.js",
            "data_roll_ntsp_part3.js"

        ];

        // NTSP MERIT DATA FILES
        const MERIT_FILES_NTSP = [
            "data_ntsp_merit_part1.js",
            "data_ntsp_merit_part2.js",
            "data_ntsp_merit_part3.js"

        ];

        // TSP FILES
        const ROLL_FILES_TSP = ["data_roll_tsp1.js"];
        const MERIT_FILES_TSP = ["data_merit_tsp1.js"];

        // Track loaded files
        const LOADED_FILES = new Set();

        // --- 2. SMART LOADER FUNCTIONS ---
        function loadScript(src) {
            return new Promise((resolve, reject) => {
                if (LOADED_FILES.has(src)) {
                    resolve(true);
                    return;
                }

                const script = document.createElement('script');
                script.src = src;
                script.onload = () => {
                    LOADED_FILES.add(src);
                    resolve(true);
                };
                script.onerror = () => {
                    console.error("Error loading:", src);
                    resolve(false);
                };
                document.body.appendChild(script);
            });
        }

        // --- LOADER CONTROLS ---
        function showLoading(msg, subMsg = "Loading data files...") {
            document.getElementById('loader-msg').innerText = msg;
            document.getElementById('loader-sub').innerText = subMsg;
            document.getElementById('global-loader').style.display = 'flex';
        }

        function hideLoading() {
            document.getElementById('global-loader').style.display = 'none';
        }

        function checkRollInMemory(roll, type) {
            const db = (type === "TSP") ? window.TSP_ROLL_DATA : window.NTSP_ROLL_DATA;
            return db && db[roll];
        }

        function checkMeritInMemory(rank, type) {
            const db = (type === "TSP") ? window.TSP_MERIT_DATA : window.NTSP_MERIT_DATA;
            return db && db[rank];
        }

        const CAT_ORDER = ["GEN", "OBC", "EWS", "MBC", "SC", "ST", "SAH"];

        const SUB_TYPES = [{
                key: "DIV",
                label: "Divorcee"
            },
            {
                key: "EXM",
                label: "Ex-Serviceman"
            },
            {
                key: "EXM SP",
                label: "Ex-S + Sports"
            }, // Combined
            {
                key: "LDCP",
                label: "LDCP/PH"
            },
            {
                key: "LDCP DIV",
                label: "LDCP + Div"
            }, // Combined
            {
                key: "LDCP EXM",
                label: "LDCP + Ex-S"
            }, // Combined
            {
                key: "LDCP SP",
                label: "LDCP + Sports"
            }, // Combined
            {
                key: "SP",
                label: "Sports Person"
            },
            {
                key: "SP DIV",
                label: "Sport + Div"
            }, // Combined
            {
                key: "WID",
                label: "Widow"
            }
        ];

        let CURRENT_DB = {};
        let CANDIDATE = null;
        let CURRENT_TYPE = "NTSP";

        function switchMode(mode) {
            document.querySelectorAll('.toggle-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.input-section').forEach(d => d.classList.remove('active'));
            document.querySelectorAll('.result-container').forEach(d => d.style.display = 'none');
            document.getElementById('status-msg').innerHTML = "";

            if (mode === 'search') {
                document.querySelectorAll('.toggle-btn')[1].classList.add('active');
                document.getElementById('input-search').classList.add('active');
            } else {
                document.querySelectorAll('.toggle-btn')[0].classList.add('active');
                document.getElementById('input-analyze').classList.add('active');
            }
        }

        function loadDB(type) {
            CURRENT_TYPE = type;
            if (type === "TSP") {
                CURRENT_DB = window.TSP_MERIT_DATA || {};
                return window.TSP_ROLL_DATA || {};
            } else {
                CURRENT_DB = window.NTSP_MERIT_DATA || {};
                return window.NTSP_ROLL_DATA || {};
            }
        }

        // 1. Function to Render Cutoff Table with Vacancy
        function renderCutoff(type) {
            const display = document.getElementById('cutoff-display-area');
            const tbody = document.getElementById('cutoff-table-body');
            const title = document.getElementById('cutoff-title');
            const hzRow = document.getElementById('hz-cutoff-row');

            // Set Title
            title.innerText = `üèÜ ${type} OFFICIAL CUTOFF (PRE DV)`;

            // Get Data safely
            const mainData = (CUTOFF_DB && CUTOFF_DB[type]) ? CUTOFF_DB[type] : {};
            const hzData = (HORIZONTAL_CUTOFF && HORIZONTAL_CUTOFF[type]) ? HORIZONTAL_CUTOFF[type] : [];

            // Helper to format Cell: Cutoff (Top) + Vacancy (Bottom)
            const fmt = (obj) => {
                if (!obj || !obj.cut) return '-';
                // Cutoff Bold, Vacancy Small & Grey
                return `<div style="line-height:1.1;">
                            <span>${obj.cut}</span>
                            <div style="font-size:0.6rem; color:#666; font-weight:normal; margin-top:1px;">Posts: ${obj.vac}</div>
                        </div>`;
            };

            // Build Matrix Table Header
            let html = `<thead>
                <tr>
                    <th>Cat</th>
                    <th>GEN</th>
                    <th>FEM</th>
                    <th>WID</th>
                    <th>DIV</th>
                    <th>EX</th>
                </tr>
            </thead><tbody>`;

            // Build Rows
            for (const [cat, vals] of Object.entries(mainData)) {
                html += `<tr>
                    <td>${cat}</td>
                    <td>${fmt(vals.GEN)}</td>
                    <td>${fmt(vals.FEM)}</td>
                    <td>${fmt(vals.WID)}</td>
                    <td>${fmt(vals.DIV)}</td>
                    <td>${fmt(vals.EX)}</td>
                </tr>`;
            }
            html += `</tbody>`;
            tbody.innerHTML = html;

            // Build Horizontal Row (LDCP/SPORTS etc)
            hzRow.innerHTML = hzData.map(d => {
                const valDisp = d.cut === "NA" ? "NA" : d.cut;
                return `<div class="hz-tag" style="text-align:center;">
                            <span style="display:block;">${d.label}: ${valDisp}</span>
                            <span style="font-size:0.6rem; color:#666; font-weight:normal;">(Posts: ${d.vac})</span>
                        </div>`;
            }).join('');
        }

        // 2. Initialize on Load
        document.addEventListener('DOMContentLoaded', () => {
            renderCutoff('NTSP'); // Default Load

            // Link Search Tab Dropdown
            const searchSelect = document.getElementById('examTypeSearch');
            if (searchSelect) {
                searchSelect.addEventListener('change', (e) => {
                    renderCutoff(e.target.value);
                    const anaSelect = document.getElementById('examTypeAnalyze');
                    if (anaSelect) anaSelect.value = e.target.value;
                });
            }

            // Link Analyze Tab Dropdown
            const analyzeSelect = document.getElementById('examTypeAnalyze');
            if (analyzeSelect) {
                analyzeSelect.addEventListener('change', (e) => {
                    renderCutoff(e.target.value);
                    const srchSelect = document.getElementById('examTypeSearch');
                    if (srchSelect) srchSelect.value = e.target.value;
                });
            }
        });

        async function executeSearch() {
            const roll = document.getElementById('rollInput').value.trim();
            const type = document.getElementById('examTypeSearch').value;
            const status = document.getElementById('status-msg');

            // Reset UI
            document.getElementById('result-search').style.display = 'none';
            document.getElementById('cutoff-display-area').style.display = 'none';
            status.innerText = ""; // Clear old status

            // --- CHANGE 1: 7 DIGIT VALIDATION ---
            if (!roll) {
                status.innerText = "Please enter Roll Number";
                status.style.color = "red";
                return;
            }

            if (roll.length !== 6) {
                status.innerText = "‚ö†Ô∏è Error: Roll Number must be exactly 6 digits!";
                status.style.color = "red";
                return;
            }

            // SHOW NEW LOADER
            showLoading("Searching Database...", "Scanning records for Roll: " + roll);

            // 1. SELECT FILE LIST
            const rollFileList = (type === "TSP") ? ROLL_FILES_TSP : ROLL_FILES_NTSP;
            const meritFileList = (type === "TSP") ? MERIT_FILES_TSP : MERIT_FILES_NTSP;

            let foundData = null;

            // 2. FIND ROLL NUMBER
            for (const file of rollFileList) {
                foundData = checkRollInMemory(roll, type);
                if (foundData) break;

                if (!LOADED_FILES.has(file)) {
                    // Update Loader Text
                    showLoading("Scanning Database...", `Loading file: ${file}`);
                    await loadScript(file);
                    foundData = checkRollInMemory(roll, type);
                    if (foundData) break;
                }
            }

            if (!foundData) {
                hideLoading(); // Hide Loader
                status.innerText = "Roll Number Not Found!";
                status.style.color = "red";
                return;
            }

            // 3. FIND MERIT DATA
            const meritRank = parseInt(foundData.Merit);
            showLoading("Roll Found!", `Retrieving Rank Data (${meritRank})...`);

            for (const mFile of meritFileList) {
                if (checkMeritInMemory(meritRank, type)) break;

                if (!LOADED_FILES.has(mFile)) {
                    await loadScript(mFile);
                    if (checkMeritInMemory(meritRank, type)) break;
                }
            }

            // 4. DISPLAY RESULT
            setTimeout(() => {
                loadDB(type);

                // Candidate Data Set
                CANDIDATE = {
                    ...foundData,
                    Merit: meritRank
                };

                const det = CURRENT_DB[CANDIDATE.Merit] || {};
                CANDIDATE.Cat = (det.Category || "OTHER").toUpperCase();
                CANDIDATE.Gen = (det.Gender || "OTHER").toUpperCase();
                CANDIDATE.Shift = String(det.Shift);
                CANDIDATE.SubRaw = (det.SubCat || "").toUpperCase();
                CANDIDATE.Tsp = (det.TSP || "").toUpperCase().includes("YES") || (det.TSP || "").toUpperCase().includes("TSP");

                document.getElementById('d_roll').innerText = roll;
                document.getElementById('d_name').innerText = CANDIDATE.Name;
                document.getElementById('d_father').innerText = CANDIDATE.Father;
                document.getElementById('d_mother').innerText = CANDIDATE.Mother;
                document.getElementById('d_raw').innerText = CANDIDATE.RawMark;
                document.getElementById('d_final').innerText = CANDIDATE.FinalMark;
                document.getElementById('d_merit').innerText = CANDIDATE.Merit;
                document.getElementById('d_cat').innerText = CANDIDATE.Cat;
                document.getElementById('d_gender').innerText = CANDIDATE.Gen;
                document.getElementById('d_shift').innerText = "Shift " + CANDIDATE.Shift;
                document.getElementById('d_tsp').innerText = CANDIDATE.Tsp ? "YES" : "NO";

                // Attendance Data
                const sData = SHIFT_ATTENDANCE[CANDIDATE.Shift] || {
                    date: "N/A",
                    total: "-",
                    pres: "-",
                    abs: "-",
                    per: "-"
                };
                document.getElementById('d_exam_date').innerText = sData.date;
                document.getElementById('d_total_cands').innerText = sData.total;
                document.getElementById('d_present').innerHTML = `${sData.pres} <span style="font-size:0.65rem; color:#28a745;">(${sData.per})</span>`;
                document.getElementById('d_absent').innerText = sData.abs;

                let subDisp = "None";
                SUB_TYPES.forEach(s => {
                    if (CANDIDATE.SubRaw.includes(s.key) || (s.key === "LDCP" && (CANDIDATE.SubRaw.includes("BL") || CANDIDATE.SubRaw.includes("LD")))) subDisp = s.label;
                });
                if (subDisp === "None" && CANDIDATE.SubRaw.length > 1) subDisp = CANDIDATE.SubRaw;
                document.getElementById('d_subcat').innerText = subDisp;

                let rv = parseFloat(CANDIDATE.RawMark);
                document.getElementById('d_rightq').innerText = !isNaN(rv) ? (rv / 1.66).toFixed(2) : "N/A";

                let rawM = parseFloat(CANDIDATE.RawMark) || 0;
                let finM = parseFloat(CANDIDATE.FinalMark) || 0;
                let diff = finM - rawM;
                let diffEl = document.getElementById('d_diff');
                diffEl.innerText = (diff > 0 ? "+" : "") + diff.toFixed(4);
                diffEl.style.color = diff >= 0 ? "#28a745" : "#dc3545";

                document.getElementById('res_start').value = 1;
                document.getElementById('res_end').value = CANDIDATE.Merit;

                runSearchLogic(1, CANDIDATE.Merit);

                hideLoading(); // HIDE LOADER
                document.getElementById('result-search').style.display = 'block';
            }, 100);
        }

        function runSearchLogic(start, end) {
            let deepStart = start;
            let deepEnd = CANDIDATE.Merit;
            let isSafeMode = false;

            if (start > CANDIDATE.Merit) {
                isSafeMode = true;
                deepStart = 1;
                deepEnd = CANDIDATE.Merit;
            }

            document.getElementById('lbl-ov-stats').innerText = `üåê Overall Stats (Rank ${start}-${end})`;
            document.getElementById('lbl-sh-stats').innerText = `‚ö° Shift ${CANDIDATE.Shift} Stats (Rank ${start}-${end})`;

            const opacity = isSafeMode ? "0.4" : "1";
            document.getElementById('rt-wrapper-1').style.opacity = opacity;
            document.getElementById('rt-wrapper-3').style.opacity = opacity;
            document.getElementById('rt-wrapper-2').style.opacity = "1";
            document.getElementById('rt-wrapper-4').style.opacity = "1";

            calculateSearchTables(start, end);
            calculateBadges(deepStart, deepEnd);
        }

        async function updateSearchResult() {
            let s = parseInt(document.getElementById('res_start').value) || 1;
            let e = parseInt(document.getElementById('res_end').value) || CANDIDATE.Merit;
            const status = document.getElementById('status-msg');

            if (s > e) {
                alert("Start > End!");
                return;
            }

            // SHOW LOADER
            showLoading("Updating Range...", "Checking data availability...");

            const meritFileList = (CURRENT_TYPE === "TSP") ? MERIT_FILES_TSP : MERIT_FILES_NTSP;

            for (const mFile of meritFileList) {
                if (checkMeritInMemory(e, CURRENT_TYPE)) break;

                if (!LOADED_FILES.has(mFile)) {
                    showLoading("Downloading Data...", `Fetching: ${mFile}`);
                    await loadScript(mFile);
                    loadDB(CURRENT_TYPE);
                    if (checkMeritInMemory(e, CURRENT_TYPE)) break;
                }
            }

            // DELAY for UI Update
            setTimeout(() => {
                runSearchLogic(s, e);
                hideLoading(); // HIDE LOADER
            }, 100);
        }

        function resetSearchAnalysis() {
            document.getElementById('res_start').value = 1;
            document.getElementById('res_end').value = CANDIDATE.Merit;
            runSearchLogic(1, CANDIDATE.Merit);
            // Show Cutoff Table again
            document.getElementById('cutoff-display-area').style.display = 'block';
        }

        async function executeAnalyze() {
            const type = document.getElementById('examTypeAnalyze').value;
            const start = parseInt(document.getElementById('ana_start').value);
            const end = parseInt(document.getElementById('ana_end').value);
            const status = document.getElementById('status-msg');

            document.getElementById('result-search').style.display = 'none';
            document.getElementById('result-analyze').style.display = 'none';
            document.getElementById('cutoff-display-area').style.display = 'none';

            // --- CHANGE 2: 500,000 LIMIT VALIDATION ---
            if (!start || !end) {
                status.innerHTML = "Please enter Start and End Rank!";
                status.style.color = "red";
                return;
            }

            if (start > end) {
                status.innerHTML = "Error: Start Rank cannot be greater than End Rank!";
                status.style.color = "red";
                return;
            }

            if (end > 300000) {
                status.innerHTML = "‚ö†Ô∏è Error: Max analysis limit is 300,000!";
                status.style.color = "red";
                return;
            }

            // SHOW LOADER
            showLoading("Preparing Analysis...", "Checking data segments...");

            const meritFileList = (type === "TSP") ? MERIT_FILES_TSP : MERIT_FILES_NTSP;

            for (const mFile of meritFileList) {
                if (checkMeritInMemory(end, type)) break;

                if (!LOADED_FILES.has(mFile)) {
                    showLoading("Loading Data...", `Downloading segment: ${mFile}`);
                    await loadScript(mFile);
                    if (checkMeritInMemory(end, type)) break;
                }
            }

            showLoading("Crunching Numbers...", "Generating Statistics tables...");

            setTimeout(() => {
                loadDB(type);
                document.getElementById('ana-ov-header').innerText = `üåê Overall Stats (Rank ${start}-${end})`;
                calculateMultiShiftTables(start, end);

                hideLoading(); // HIDE LOADER
                document.getElementById('result-analyze').style.display = 'block';
            }, 200);
        }

        function calculateBadges(start, end) {
            let mySubKey = "";
            SUB_TYPES.forEach(s => {
                if (CANDIDATE.SubRaw.includes(s.key) || (s.key === "LDCP" && (CANDIDATE.SubRaw.includes("BL") || CANDIDATE.SubRaw.includes("LD")))) mySubKey = s.key;
            });

            let stats = {
                range: {
                    l: "Range Count",
                    a: 0,
                    n: 0
                },
                cat: {
                    l: "Category Rank (" + CANDIDATE.Cat + ")",
                    a: 0,
                    n: 0
                },
                gen: {
                    l: "Gender Rank (" + CANDIDATE.Gen + ")",
                    a: 0,
                    n: 0
                },
                mix: {
                    l: "Mix (" + CANDIDATE.Cat + "+" + CANDIDATE.Gen.charAt(0) + ")",
                    a: 0,
                    n: 0
                },
                sub: {
                    l: "Special Category",
                    a: 0,
                    n: 0
                },
                tsp: {
                    l: "TSP Status Check",
                    a: 0,
                    n: 0
                }
            };
            let shiftStats = JSON.parse(JSON.stringify(stats));

            for (let i = start; i <= end; i++) {
                const p = CURRENT_DB[i];
                if (!p) continue;
                let pCat = (p.Category || "OTHER").toUpperCase();
                if (!CAT_ORDER.includes(pCat)) pCat = "OTHER";
                let pGen = (p.Gender || "OTHER").toUpperCase(),
                    pTsp = (p.TSP || "").toUpperCase().includes("YES") || (p.TSP || "").toUpperCase().includes("TSP");
                let pSub = (p.SubCat || "").toUpperCase();

                const inc = (o, t) => {
                    o.a++;
                    if (!t) o.n++;
                };

                inc(stats.range, pTsp);
                if (pCat === CANDIDATE.Cat) inc(stats.cat, pTsp);
                if (pGen === CANDIDATE.Gen) inc(stats.gen, pTsp);
                if (pCat === CANDIDATE.Cat && pGen === CANDIDATE.Gen) inc(stats.mix, pTsp);
                if (mySubKey && pCat === CANDIDATE.Cat && (pSub.includes(mySubKey) || (mySubKey === "LDCP" && (pSub.includes("BL") || pSub.includes("LD"))))) inc(stats.sub, pTsp);
                if (CANDIDATE.Tsp && pTsp) stats.tsp.a++;

                if (String(p.Shift) === CANDIDATE.Shift) {
                    inc(shiftStats.range, pTsp);
                    if (pCat === CANDIDATE.Cat) inc(shiftStats.cat, pTsp);
                    if (pGen === CANDIDATE.Gen) inc(shiftStats.gen, pTsp);
                    if (pCat === CANDIDATE.Cat && pGen === CANDIDATE.Gen) inc(shiftStats.mix, pTsp);
                    if (mySubKey && pCat === CANDIDATE.Cat && (pSub.includes(mySubKey) || (mySubKey === "LDCP" && (pSub.includes("BL") || pSub.includes("LD"))))) inc(shiftStats.sub, pTsp);
                    if (CANDIDATE.Tsp && pTsp) shiftStats.tsp.a++;
                }
            }
            renderRankTable("tb-overall-rank", stats, mySubKey, CANDIDATE.Tsp);
            renderRankTable("tb-shift-rank", shiftStats, mySubKey, CANDIDATE.Tsp);
        }

        const z = () => ({
            m: 0,
            f: 0,
            o: 0,
            tot: 0,
            tsp: 0
        });

        const createEmptyMatrix = () => {
            let m = {};
            [...CAT_ORDER, "OTHER"].forEach(c => {
                let subObj = {};
                SUB_TYPES.forEach(sub => {
                    subObj[sub.key] = z();
                });
                m[c] = {
                    ...z(),
                    pure: z(),
                    subs: subObj
                };
            });
            return m;
        };

        function processRow(m, p) {
            let cat = (p.Category || "OTHER").toUpperCase();
            if (!CAT_ORDER.includes(cat)) cat = "OTHER";
            let gen = (p.Gender || "OTHER").trim().toUpperCase();
            let tsp = (p.TSP || "").toUpperCase().includes("YES") || (p.TSP || "").toUpperCase().includes("TSP");
            let sub = (p.SubCat || "").trim().toUpperCase();

            let r = m[cat];
            let gKey = 'o';
            if (gen === 'MALE') gKey = 'm';
            else if (gen === 'FEMALE') gKey = 'f';

            if (CURRENT_TYPE === 'NTSP') {
                if (tsp) {
                    r.tsp++;
                    r.tot++;
                } else {
                    r[gKey]++;
                    r.tot++;
                }
            } else {
                r[gKey]++;
                r.tot++;
            }

            let isSpecial = false;
            SUB_TYPES.forEach(s => {
                if (sub === s.key) {
                    isSpecial = true;
                    let sr = r.subs[s.key];
                    if (CURRENT_TYPE === 'NTSP') {
                        if (tsp) {
                            sr.tsp++;
                            sr.tot++;
                        } else {
                            sr[gKey]++;
                            sr.tot++;
                        }
                    } else {
                        sr[gKey]++;
                        sr.tot++;
                    }
                }
            });

            if (!r.pure) r.pure = {
                m: 0,
                f: 0,
                o: 0,
                tsp: 0,
                tot: 0
            };
            if (!isSpecial) {
                if (CURRENT_TYPE === 'NTSP') {
                    if (tsp) {
                        r.pure.tsp++;
                        r.pure.tot++;
                    } else {
                        r.pure[gKey]++;
                        r.pure.tot++;
                    }
                } else {
                    r.pure[gKey]++;
                    r.pure.tot++;
                }
            }
        }

        function getTableHeader(isShift = false) {
            let bg = isShift ? "background:#f3e5f5;color:#4a148c;" : "";

            if (CURRENT_TYPE === 'NTSP') {
                return `<thead>
                    <tr>
                        <th class="col-cat" rowspan="2" style="${bg}">Category</th>
                        <th colspan="3" class="ntsp-header">NTSP</th>
                        <th rowspan="2" class="tsp-super-header">TSP</th>
                        <th rowspan="2" style="${bg}">Total</th>
                    </tr>
                    <tr>
                        <th style="${bg}">Male</th>
                        <th style="${bg}">Female</th>
                        <th style="${bg}">THIRD</th> </tr>
                </thead>`;
            } else {
                return `<thead><tr><th class="col-cat" style="${bg}">Category</th><th style="${bg}">Male</th><th style="${bg}">Female</th><th style="${bg}">THIRD</th><th style="${bg}">Total</th></tr></thead>`;
            }
        }

        function calculateSearchTables(start, end) {
            let gm = createEmptyMatrix(),
                sm = createEmptyMatrix();
            for (let i = start; i <= end; i++) {
                const p = CURRENT_DB[i];
                if (!p) continue;
                processRow(gm, p);
                if (String(p.Shift) === CANDIDATE.Shift) processRow(sm, p);
            }
            document.getElementById("tb-overall-stats").innerHTML = getTableHeader() + `<tbody id="b1"></tbody>`;
            renderDeepTable(document.getElementById("b1"), gm);
            document.getElementById("tb-shift-stats").innerHTML = getTableHeader(true) + `<tbody id="b2"></tbody>`;
            renderDeepTable(document.getElementById("b2"), sm);
        }

        function calculateMultiShiftTables(start, end) {
            let gm = createEmptyMatrix();
            let shifts = {};

            for (let i = start; i <= end; i++) {
                const p = CURRENT_DB[i];
                if (!p) continue;
                processRow(gm, p);
                let s = String(p.Shift);
                if (!shifts[s]) shifts[s] = createEmptyMatrix();
                processRow(shifts[s], p);
            }

            const ovCont = document.getElementById('ana-overall-container');
            ovCont.innerHTML = `<div class="table-wrapper"><table class="stats-table">${getTableHeader()}<tbody></tbody></table></div>`;
            renderDeepTable(ovCont.querySelector('tbody'), gm);

            const shCont = document.getElementById('ana-shifts-container');
            shCont.innerHTML = "";
            Object.keys(shifts).sort().forEach(sk => {
                let div = document.createElement('div');
                div.className = "dynamic-shift-wrapper";
                div.innerHTML = `<div class="dynamic-shift-label">Shift ${sk}</div><div class="table-wrapper"><table class="stats-table">${getTableHeader()}<tbody></tbody></table></div>`;
                shCont.appendChild(div);
                renderDeepTable(div.querySelector('tbody'), shifts[sk]);
            });
        }

        function renderRankTable(id, d, hasSub, hasTsp) {
            const tbody = document.getElementById(id);
            tbody.innerHTML = "";
            const isTspCand = CANDIDATE.Tsp;
            const table = tbody.closest('table');
            if (table) {
                const th3 = table.querySelector('th:nth-child(3)');
                if (th3) {
                    if (isTspCand) {
                        th3.innerText = "Rank (TSP Only)";
                        th3.style.background = "#fd7e14";
                    } else {
                        th3.innerText = "Rank (NTSP Only)";
                        th3.style.background = "";
                    }
                }
            }

            const k = ["range", "gen", "cat", "mix"];
            if (hasSub) k.push("sub");

            k.forEach(key => {
                let v = d[key];
                let col2Val = 0;
                if (isTspCand) {
                    col2Val = v.a - v.n;
                } else {
                    col2Val = v.n;
                }

                tbody.innerHTML += `<tr>
                    <td>${v.l}</td>
                    <td class="st-val">${v.a}</td>
                    <td class="st-val" style="font-weight:800; color:${isTspCand ? '#d35400' : '#0056b3'}">
                        ${col2Val}
                    </td>
                </tr>`;
            });
        }

        function renderDeepTable(tbody, data) {
            let gt = z();
            gt.all = 0;

            [...CAT_ORDER, "OTHER"].forEach(c => {
                let d = data[c];
                if (d.tot === 0) return;

                gt.m += d.m;
                gt.f += d.f;
                gt.o += d.o;
                gt.tsp += d.tsp;
                gt.all += d.tot;

                let subSum = {
                    m: 0,
                    f: 0,
                    o: 0,
                    tsp: 0,
                    tot: 0
                };
                let hasSubs = false;

                SUB_TYPES.forEach(s => {
                    let sd = d.subs[s.key];
                    if (sd.tot > 0) {
                        hasSubs = true;
                        subSum.m += sd.m;
                        subSum.f += sd.f;
                        subSum.o += sd.o;
                        subSum.tsp += sd.tsp;
                        subSum.tot += sd.tot;
                    }
                });

                let openM = d.m - subSum.m;
                let openF = d.f - subSum.f;
                let openO = d.o - subSum.o;
                let openTsp = d.tsp - subSum.tsp;
                let openTot = d.tot - subSum.tot;

                let label = hasSubs ? `${c} (Open)` : c;
                let tspCellOpen = CURRENT_TYPE === 'NTSP' ? `<td class="tsp-cell">${openTsp}</td>` : '';

                let h = `<tr>
                    <td class="col-cat"><span class="cat-tag bg-${c}">${label}</span></td>
                    <td>${openM}</td><td>${openF}</td><td>${openO}</td>
                    ${tspCellOpen}<td style="font-weight:bold;">${openTot}</td>
                </tr>`;

                SUB_TYPES.forEach(s => {
                    let sd = d.subs[s.key];
                    if (sd.tot > 0) {
                        let tspCellSub = CURRENT_TYPE === 'NTSP' ? `<td class="tsp-cell">${sd.tsp}</td>` : '';
                        h += `<tr class="sub-row">
                            <td class="col-cat sub-label">‚Ü≥ ${s.label}</td>
                            <td>${sd.m}</td><td>${sd.f}</td><td>${sd.o}</td>
                            ${tspCellSub}<td>${sd.tot}</td>
                        </tr>`;
                    }
                });

                if (hasSubs) {
                    let tspCellTot = CURRENT_TYPE === 'NTSP' ? `<td class="tsp-cell" style="font-weight:bold;">${d.tsp}</td>` : '';
                    h += `<tr style="background:#fff3cd; border-bottom:2px solid #ddd;">
                        <td class="col-cat" style="font-weight:bold; color:#856404; text-align:right!important; padding-right:10px!important;">Total ${c} ‚û§</td>
                        <td style="font-weight:bold;">${d.m}</td>
                        <td style="font-weight:bold;">${d.f}</td>
                        <td style="font-weight:bold;">${d.o}</td>
                        ${tspCellTot}
                        <td style="font-weight:bold; color:#000;">${d.tot}</td>
                    </tr>`;
                }

                tbody.innerHTML += h;
            });

            if (gt.all > 0) {
                let tspCellTot = CURRENT_TYPE === 'NTSP' ? `<td class="tsp-cell">${gt.tsp}</td>` : '';
                tbody.innerHTML += `<tr class="grand-total-row">
                    <td class="col-cat">GRAND TOTAL</td>
                    <td>${gt.m}</td><td>${gt.f}</td><td>${gt.o}</td>
                    ${tspCellTot}<td>${gt.all}</td>
                </tr>`;
            }
        }
    </script>
</body>

</html>
